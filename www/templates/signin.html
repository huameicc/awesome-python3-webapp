{% extends '__base__.html' %}

{% block title %}User Sign In{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="uk-grid" data-uk-grid-margin>
  <div class="uk-width-medium-2-3">
    <h1 class="uk-h1">登录帐号</h1>
    <form class="uk-form uk-form-stacked" id="signin" @submit.prevent="submit">
      <div class="uk-alert uk-alert-danger uk-hidden"></div>
      <div class="uk-form-row">
        <label class="uk-form-label" for="email">邮箱:</label>
        <div class="uk-form-controls">
          <input type="text" id="email" maxlength="50" placeholder="邮箱" v-model.trim="email">
        </div>
      </div>
      <div class="uk-form-row">
        <label class="uk-form-label" for="passwd">设置密码:</label>
        <div class="uk-form-controls">
          <input type="password" id="passwd" maxlength="50" placeholder="输入密码" v-model="passwd">
        </div>
      </div>
      <div class="uk-form-row">
        <button class="uk-button uk-button-primary" type="submit"><i class="uk-icon-sign-in"></i>登录</button>
      </div>
    </form>
  </div>
</div>
{% endblock%}


{% block bodyend %}
<script>
    function validateEmail(email) {
        let reg = /^[a-z0-9\-._]+@[a-z0-9\-_](?:.[a-z0-9\-_]+){1,4}$/i;
        return reg.test(email);
    }

    $(document).ready(function () {
        let vm = new Vue({
            el: '#signin',
            data: {
                email: '',
                passwd: '',
            },
            methods: {
                submit: function (evt) {
                    let $form = $('#signin');
                    if (!validateEmail(this.email)) {
                        return $form.showFormError({msg: '邮箱地址不合法！', data: 'email'});
                    }
                    if (this.passwd.length < 6) {
                        return $form.showFormError({msg: '密码错误!', data: 'passwd'});
                    }
                    $form.postJson('/api/authenticate', {
                        email: this.email,
                        passwd: CryptoJS.SHA1(this.email + ':' + this.passwd).toString()
                    }, function (err) {
                        if (err) {
                            return $form.showFormError(err);
                        }
                        return location.assign('/');
                    });
                }
            }
        });
    });
</script>
{% endblock %}